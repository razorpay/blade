name: Blade Validate

on: [pull_request]

env:
  GITHUB_ACCESS_TOKEN: ${{ secrets.CI_BOT_TOKEN }}

jobs:
  validate:
    name: Validate Source Code
    runs-on: ubuntu-latest # nosemgrep: non-self-hosted-runner
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v3
      - name: Use Node v18
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
      - name: Pre-Generate Documentation Lock File
        run: yarn generate-docs-lockfile
      - name: Setup Cache & Install Dependencies
        uses: ./.github/actions/install-dependencies
      - name: Build Blade
        run: yarn build
        working-directory: packages/blade
      - name: Lint Source Code
        run: yarn lint
      - name: Run TypeScript Checks
        run: yarn typecheck
        working-directory: packages/blade

  test:
    name: Run Tests (${{ matrix.shard }})
    runs-on: ubuntu-latest # nosemgrep: non-self-hosted-runner
    strategy:
      fail-fast: false
      matrix:
        shard: [1/4, 2/4, 3/4, 4/4]
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v3
      - name: Use Node v18
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
      - name: Setup Cache & Install Dependencies
        uses: ./.github/actions/install-dependencies
      - name: Run Unit Tests with Coverage
        run: yarn test --coverage
        working-directory: packages/blade
        env:
          SHARD: ${{ matrix.shard }}

      - name: Sanitize shard number
        id: sanitize-shard
        run: |
         SANITIZED=$(echo "${{ matrix.shard }}" | sed 's|/|-of-|g')
         echo "sanitized=$SANITIZED" >> $GITHUB_OUTPUT

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4  
        with:
          name: coverage-report-${{ steps.sanitize-shard.outputs.sanitized }}
          path: packages/blade/coverage
          retention-days: 1

  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Use Node v18
        uses: actions/setup-node@v3
        with:
          node-version: 18.12.1
      - name: Setup Cache & Install Dependencies
        uses: ./.github/actions/install-dependencies
      - name: Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
      - name: Create Merged Coverage Report
        run: |
          # Create directory for nyc output
          mkdir -p .nyc_output
          
          # Find and copy all coverage-final.json files to .nyc_output
          find coverage-reports -name "coverage-final.json" -exec cp {} .nyc_output/ \;
          
          # Generate merged report
          npx nyc report --reporter=json
          
          # Ensure output directory exists
          mkdir -p packages/blade/coverage
          
          # Copy the merged report to expected location
          cp coverage/coverage-final.json packages/blade/coverage/
      - name: Report Coverage
        uses: ArtiomTr/jest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.CI_BOT_TOKEN }}
          coverage-file: ./packages/blade/coverage/coverage-final.json
          base-coverage-file: ./packages/blade/coverage/coverage-final.json
